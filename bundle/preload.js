const{contextBridge:contextBridge,shell:shell}=require("electron"),ytch=require("yt-channel-info"),ytpl=require("ytpl"),ytsr=require("ytsr"),ytdl=require("ytdl-core"),youtubeSuggest=require("youtube-suggest"),ytrend=require("@freetube/yt-trending-scraper"),{SponsorBlock:SponsorBlock}=require("sponsorblock-api"),SocksProxyAgent=require("socks-proxy-agent"),HttpProxyAgent=require("http-proxy-agent"),HttpsProxyAgent=require("https-proxy-agent"),fs=require("fs"),path=require("path"),https=require("https"),STORAGE_PATH=path.resolve(__dirname,"storage.json"),makeAgent=e=>{switch(e.protocol){case"http":return new HttpProxyAgent({host:e.host,port:e.port});case"https":return new HttpsProxyAgent({host:e.host,port:e.port});case"socks4":return new SocksProxyAgent({host:e.host,port:e.port,type:4});case"socks5":return new SocksProxyAgent({host:e.host,port:e.port,type:5})}};contextBridge.exposeInMainWorld("API",{scrapeVideo:e=>ytdl.getInfo(`https://www.youtube.com/watch?v=${e}`),scrapeVideoProxy:(e,t)=>ytdl.getInfo(`https://www.youtube.com/watch?v=${e}`,{requestOptions:{agent:makeAgent(t)}}),scrapeChannelInfo:e=>ytch.getChannelInfo(e,0),scrapeChannelVideos:e=>ytch.getChannelVideos(e,"latest",0),scrapeChannelPlaylists:e=>ytch.getChannelPlaylistInfo(e,"last",0),scrapeVideosMore:e=>ytch.getChannelVideosMore(e),scrapePlaylistsMore:e=>ytch.getChannelPlaylistsMore(e),scrapePlaylistVideos:e=>ytpl(e),scrapePlaylistVideosProxy:(e,t)=>ytpl(e,{requestOptions:{agent:makeAgent(t)}}),scrapeSearchResults:(e,t)=>ytsr(`${e}`,t),scrapeSearchResultsProxy:(e,t)=>ytsr(`${e}`,{requestOptions:{agent:makeAgent(t)}}),scrapeSearchResultsMore:e=>ytsr.continueReq(e),scrapeSuggests:e=>youtubeSuggest(e),scrapeSuggestsProxy:(e,t)=>youtubeSuggest(e,makeAgent(t)),scrapeTrending:e=>ytrend.scrape_trending_page(e),isYTVideoURL:e=>ytdl.validateURL(e),getVideoId:e=>ytdl.getVideoID(e),YTDLChooseFormat:(e,t)=>ytdl.chooseFormat(e,{quality:t}),getSponsorblockInfo:(e,t)=>new SponsorBlock(t).getSegmentsPrivately(e,["sponsor","intro","outro","interaction","selfpromo","music_offtopic","preview"]),postSponsorblockInfo:(e,t,r)=>new SponsorBlock(t).postSegments(e,r),readStorage:()=>new Promise((e=>{let t=fs.createReadStream(STORAGE_PATH);t.setEncoding("UTF8"),t.on("data",e)})),writeStorage:e=>{let t=fs.createWriteStream(STORAGE_PATH);t.write(JSON.stringify(e)),t.end()},openExternalLink:e=>shell.openExternal(e),getCaption:async(e,t)=>{const r=e.player_response.captions.playerCaptionsTracklistRenderer.captionTracks;if(r&&r.length){const o=r.find((e=>e.languageCode===t)),s="temp",n=`${e.videoDetails.videoId}.${o.languageCode}.vtt`;return new Promise((t=>https.get(`${o.baseUrl}&fmt=vtt`,(r=>{r.pipe(fs.createWriteStream(path.resolve(__dirname,s,n))),r.on("end",(()=>{t({videoId:e.videoDetails.videoId,languageCode:o.languageCode,simpleText:o.name.simpleText})}))}))))}},clearTempFolder:()=>{const e=path.resolve(__dirname,"temp");fs.readdir(e,((t,r)=>{if(t)throw t;for(const t of r)fs.unlink(path.join(e,t),(e=>{if(e)throw e}))}))},makeRequest:e=>new Promise((t=>https.get(e,t)))});